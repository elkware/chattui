package ui

import (
	"bytes"
	"encoding/base64"
	"image/png"
	"strings"

	"chattui/internal/config"
	tv "github.com/rivo/tview"
)

const logo = "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"

type ConfigUI struct {
	Form     *tv.Form
	root     *tv.Flex
	app      *tv.Application
	FormRoot *tv.Flex
}

func (c *ConfigUI) Init() {
	c.Form = tv.NewForm()

	imgBytes, _ := base64.StdEncoding.DecodeString(logo)
	img, err := png.Decode(bytes.NewReader(imgBytes))
	if err != nil {
		panic(err)
	}

	c.Form.AddImage("", img, 0, 0, 64)
	c.Form.AddInputField("Open AI API Key", "", 0, nil, nil)
	c.Form.AddTextArea("Custom instructions", "", 0, 0, 0, nil)
	c.Form.AddButton("Save", func() {
		apiKey := c.Form.GetFormItemByLabel("Open AI API Key").(*tv.InputField).GetText()
		instructions := c.Form.GetFormItemByLabel("Custom instructions").(*tv.TextArea).GetText()
		instructions = strings.ReplaceAll(instructions, "\n", " ")
		instructions = strings.ReplaceAll(instructions, "\r", " ")
		instructions = strings.Trim(instructions, " ")
		config.AppConfig.CustomInstructions = instructions
		config.AppConfig.ApiKey = apiKey
		config.AppConfig.Save()
		c.app.SetRoot(c.root, true)
	})
	c.Form.AddButton("Cancel", func() {
		c.app.SetRoot(c.root, true)
	})
	c.Form.SetBorder(true)
	c.Form.SetTitle("Config")
	c.Form.SetButtonsAlign(tv.AlignCenter)
	c.Form.SetRect(0, 0, 60, 22)
	c.FormRoot = tv.NewFlex().SetDirection(tv.FlexRow).
		AddItem(nil, 0, 1, false).
		AddItem(
			tv.NewFlex().AddItem(nil, 0, 1, false).AddItem(c.Form, 60, 1, true).AddItem(nil, 0, 1, false),
			22, 1, false).
		AddItem(nil, 0, 1, false)
}

func NewConfigUI(app *tv.Application, root *tv.Flex) *ConfigUI {
	ui := &ConfigUI{}
	ui.Init()
	ui.root = root
	ui.app = app
	return ui
}
